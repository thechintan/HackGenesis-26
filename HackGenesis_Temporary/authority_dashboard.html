<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Authority Dashboard - CoastalEye AI</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.0.3/src/css/icons.css">
    <style>
        :root {
            --brand-purple: #6C2BF2;
            --deep-purple: #0D0716;
            --text: #EDEAFB;
            --text-muted: rgba(237, 234, 251, 0.72);
            --accent-gold: #E2B714;
            --glass-bg: rgba(255, 255, 255, 0.04);
            --glass-border: rgba(255, 255, 255, 0.1);
            --danger: #FF4444;
            --warning: #FFAA00;
            --success: #00CC66;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at 10% 10%, rgba(108, 43, 242, 0.1), transparent 40%), var(--deep-purple);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
            margin-bottom: 30px;
        }

        .logo-section h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin: 0;
            background: linear-gradient(90deg, #fff, var(--brand-purple));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .pulse {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--success);
            animation: pulse-kf 2s infinite;
        }

        @keyframes pulse-kf {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-header h3 {
            margin: 0;
            font-family: 'Playfair Display', serif;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ai-tag {
            background: rgba(108, 43, 242, 0.2);
            color: var(--brand-purple);
            border: 1px solid var(--brand-purple);
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .feed-container {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 10px;
        }

        /* Scrollbar styles */
        .feed-container::-webkit-scrollbar {
            width: 5px;
        }

        .feed-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .feed-container::-webkit-scrollbar-thumb {
            background: var(--glass-border);
            border-radius: 10px;
        }

        /* Card Styles */
        .card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 15px;
            transition: transform 0.2s, border-color 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            border-color: rgba(108, 43, 242, 0.3);
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .priority-High {
            background: rgba(255, 68, 68, 0.15);
            color: #FF4444;
            border: 1px solid #FF4444;
        }

        .priority-Medium {
            background: rgba(255, 170, 0, 0.15);
            color: #FFAA00;
            border: 1px solid #FFAA00;
        }

        .priority-Low {
            background: rgba(0, 204, 102, 0.15);
            color: #00CC66;
            border: 1px solid #00CC66;
        }

        .risk-score-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            border: 2px solid var(--brand-purple);
        }

        .risk-score-circle span {
            font-size: 0.5rem;
            font-weight: normal;
        }

        .card-content h4 {
            margin: 0 0 5px;
            font-size: 1.1rem;
        }

        .card-content p {
            margin: 0 0 10px;
            font-size: 0.9rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .card-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            border-top: 1px solid var(--glass-border);
            padding-top: 12px;
            flex-wrap: wrap;
            /* Make buttons responsive */
        }

        .btn {
            background: var(--brand-purple);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: rgba(255, 68, 68, 0.2);
            color: #FF4444;
            border: 1px solid #FF4444;
        }

        .image-preview {
            width: 100%;
            height: 150px;
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #000;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 3rem;
            opacity: 0.3;
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo-indicator">
                    <span class="pulse"></span> Live System Monitoring
                </div>
                <h1>Authority Response Hub</h1>
            </div>
            <div style="display: flex; gap: 15px;">
                <button class="btn btn-secondary" onclick="location.reload()">
                    <i class="ph-bold ph-arrows-clockwise"></i> Refresh
                </button>
                <button class="btn" style="background: #333;" onclick="logout()">
                    <i class="ph-bold ph-sign-out"></i> Logout
                </button>
            </div>
        </header>

        <div class="dashboard-grid">
            <div style="grid-column: 1 / -1; display: flex; gap: 10px; margin-bottom: 0px;">
                <button class="btn" id="tab-active" onclick="switchTab('active')"
                    style="background:var(--brand-purple)">Active Queue</button>
                <button class="btn btn-secondary" id="tab-all" onclick="switchTab('all')">All History</button>
            </div>

            <!-- Left Panel: AI Prioritized Community Sentinel Posts -->
            <section class="panel">
                <div class="panel-header">
                    <h3><i class="ph-bold ph-users-three"></i> Community Sentinel Posts</h3>
                    <span class="ai-tag">AI Risk Analysis</span>
                </div>
                <div id="posts-feed" class="feed-container">
                    <div class="empty-state">Loading AI analytics...</div>
                </div>
            </section>

            <!-- Right Panel ... -->
            <section class="panel">
                <div class="panel-header">
                    <h3><i class="ph-bold ph-hand-heart"></i> Humanitarian Aid Requests</h3>
                    <span class="ai-tag">AI Urgency Priority</span>
                </div>
                <div id="aid-feed" class="feed-container">
                    <div class="empty-state">Filtering emergency requests...</div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Use relative URL or same origin to avoid CORS and localhost issues
        let API_URL = window.location.origin;
        if (window.location.protocol === 'file:') {
            API_URL = 'http://127.0.0.1:8001';
        }

        let currentView = 'active';

        // Auth Check & Session Sync
        async function checkAuth() {
            let role = localStorage.getItem('role');
            const userId = localStorage.getItem('user_id');
            const token = localStorage.getItem('token');

            // 1. Sync Session Logic
            if (userId && token) {
                try {
                    const res = await fetch(`${API_URL}/auth/me?user_id=${userId}`);
                    if (res.ok) {
                        const userData = await res.json();
                        localStorage.setItem('user_name', userData.name);
                        localStorage.setItem('role', userData.role);
                        role = userData.role; // Update local var for check below
                    }
                } catch (e) {
                    console.warn("Session sync failed");
                }
            }

            // 2. Role Enforcement
            if (role !== 'authority') {
                alert('Access Denied: Authorities only.');
                window.location.href = 'frontend.html';
            }
        }

        function switchTab(view) {
            currentView = view;
            // Update buttons
            document.getElementById('tab-active').className = view === 'active' ? 'btn' : 'btn btn-secondary';
            document.getElementById('tab-active').style.background = view === 'active' ? 'var(--brand-purple)' : '';

            document.getElementById('tab-all').className = view === 'all' ? 'btn' : 'btn btn-secondary';
            document.getElementById('tab-all').style.background = view === 'all' ? 'var(--brand-purple)' : '';

            loadDashboard();
        }

        async function loadDashboard() {
            try {
                const res = await fetch(`${API_URL}/authority/dashboard-data?view=${currentView}`);
                if (!res.ok) throw new Error('Failed to fetch dashboard data');
                const data = await res.json();

                renderPosts(data.prioritized_posts || []);
                renderAidRequests(data.aid_requests || []);

            } catch (err) {
                console.error('Dashboard Load Error:', err);
                const container = document.getElementById('posts-feed');
                if (container) container.innerHTML = '<div class="empty-state">Unable to sync with command center. Check backend.</div>';
            }
        }

        function renderPosts(posts) {
            const container = document.getElementById('posts-feed');
            if (!posts || posts.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-clipboard-text"></i>No community reports currently.</div>';
                return;
            }

            container.innerHTML = posts.map(p => {
                const score = p.risk_score || 0;
                const riskLevel = score > 75 ? 'High' : (score > 40 ? 'Medium' : 'Low');
                const riskColor = score > 75 ? '#FF4444' : (score > 40 ? '#FFAA00' : '#00CC66');

                return `
                    <div class="card">
                        <div class="card-top">
                            <span class="priority-badge priority-${riskLevel}">AI PRIORITY: ${riskLevel}</span>
                            <div class="risk-score-circle" style="border-color:${riskColor}; color:${riskColor}">
                                ${score}
                                <span>SCORE</span>
                            </div>
                        </div>
                        ${p.image_data ? `<div class="image-preview" style="background-image: url('${p.image_data}')"></div>` : ''}
                        <div class="card-content">
                            <h4>${p.caption || 'Untitled Report'}</h4>
                            <p>${p.description || 'No description provided.'}</p>
                            <div class="card-meta">
                                <span><i class="ph-bold ph-map-pin"></i> ${p.location || 'Unknown'}</span>
                                <span><i class="ph-bold ph-clock"></i> ${p.created_at ? new Date(p.created_at).toLocaleTimeString() : 'N/A'}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn" onclick="updatePostStatus('${p.id}', 'Resolved', 'Dispatching Team...')">
                                <i class="ph-bold ph-truck"></i> Dispatch
                            </button>
                            <button class="btn btn-secondary" onclick="updatePostStatus('${p.id}', 'Notified', 'Alert sent to locals.')">
                                <i class="ph-bold ph-megaphone"></i> Notify Locals
                            </button>
                            <button class="btn btn-danger" onclick="updatePostStatus('${p.id}', 'Dismissed', 'Post dismissed.')">
                                <i class="ph-bold ph-warning-circle"></i> Dismiss
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderAidRequests(requests) {
            const container = document.getElementById('aid-feed');
            if (!requests || requests.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="ph-bold ph-hand-heart"></i>No active aid requests.</div>';
                return;
            }

            container.innerHTML = requests.map(req => {
                const urgency = req.urgency || 'Low';
                const timeStr = req.timestamp ? new Date(req.timestamp).toLocaleTimeString() : 'N/A';
                return `
                    <div class="card">
                        <div class="card-top">
                            <span class="priority-badge priority-${urgency}">URGENCY: ${urgency.toUpperCase()}</span>
                            <div class="risk-score-circle" style="border-color:${req.urgency_score > 70 ? '#FF4444' : (req.urgency_score > 40 ? '#FFAA00' : '#00CC66')}; color:${req.urgency_score > 70 ? '#FF4444' : (req.urgency_score > 40 ? '#FFAA00' : '#00CC66')}">
                                ${req.urgency_score || 0}
                                <span>SCORE</span>
                            </div>
                        </div>
                        <div class="card-content">
                            <h4 style="color:var(--accent-gold)">${req.needs || 'General'} Need</h4>
                            <p style="text-align:right; font-size:0.8rem; color:var(--text-muted); margin-top:-5px;">${timeStr}</p>
                            <p><strong>Reporter:</strong> ${req.user_name || 'Anonymous'} (${req.contact || 'No contact info'})</p>
                            <p>${req.description || 'No description.'}</p>
                            <div class="card-meta">
                                <span><i class="ph-bold ph-map-pin"></i> ${req.location || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="card-actions">
                            <button class="btn" style="background:var(--success)" onclick="updateAidStatus('${req.id}', 'In Progress', 'Request marked In Progress.')">
                                <i class="ph-bold ph-check-circle"></i> Respond Now
                            </button>
                            <button class="btn btn-secondary" onclick="contactUser('${req.contact || ''}')">
                                <i class="ph-bold ph-phone"></i> Contact
                            </button>
                            <button class="btn btn-secondary" onclick="delegateRequest('${req.id}')">
                                <i class="ph-bold ph-share-network"></i> Delegate
                            </button>
                            <button class="btn btn-danger" onclick="updateAidStatus('${req.id}', 'Resolved', 'Request resolved.')">
                                <i class="ph-bold ph-check"></i> Done
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function updatePostStatus(postId, status, msg) {
            if (!confirm(`Mark post as ${status}?`)) return;
            try {
                const res = await fetch(`${API_URL}/authority/posts/${postId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                if (res.ok) {
                    alert(msg);
                    loadDashboard();
                } else { alert("Failed to update status"); }
            } catch (e) { console.error(e); }
        }

        async function updateAidStatus(reqId, status, msg) {
            // "In Progress" is distinct from "Resolved"
            if (!confirm(`Mark request as ${status}?`)) return;
            try {
                const res = await fetch(`${API_URL}/authority/aid-requests/${reqId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: status })
                });
                if (res.ok) {
                    alert(msg);
                    loadDashboard();
                } else { alert("Failed to update status"); }
            } catch (e) { console.error(e); }
        }

        function contactUser(contactInfo) {
            if (!contactInfo || contactInfo === 'No info') {
                alert("No contact information provided by the user.");
                return;
            }

            // Try to detect email or phone
            const isEmail = contactInfo.includes('@');
            const isPhone = /\d{10}/.test(contactInfo);

            let action = "";
            if (isEmail) {
                if (confirm(`Send email to ${contactInfo}?`)) {
                    window.location.href = `mailto:${contactInfo}`;
                    return;
                }
            } else if (isPhone) {
                if (confirm(`Call ${contactInfo}?`)) {
                    window.location.href = `tel:${contactInfo}`;
                    return;
                }
            }

            // Fallback copy to clipboard
            navigator.clipboard.writeText(contactInfo).then(() => {
                alert(`Contact info '${contactInfo}' copied to clipboard.`);
            }).catch(() => {
                alert(`Contact Info: ${contactInfo}`);
            });
        }

        function delegateRequest(reqId) {
            const department = prompt("Enter department to delegate to (e.g., Fire Dept, Medical Team, NGO):", "Medical Team");
            if (!department) return;

            updateAidStatus(reqId, 'Delegated', `Request delegated to ${department}.`);
        }

        function takeAction(msg) {
            alert("ACTION LOGGED: " + msg);
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'frontend.html';
        }

        // Init
        checkAuth();
        loadDashboard();
        // Auto-refresh every 15 seconds
        setInterval(loadDashboard, 15000);
    </script>
</body>

</html>